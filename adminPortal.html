<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NIMELSSA Admin Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body { background: #f3f6f5; }
    .hidden { display: none; }
    .card { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand" href="#">NIMELSSA Admin</a>
      <div class="ms-auto">
        <span id="user-email" class="text-white me-3"></span>
        <button id="btn-logout" class="btn btn-outline-light btn-sm hidden">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <!-- LOGIN -->
    <div id="login-area" class="card p-4 mx-auto" style="max-width:540px;">
      <h4 class="mb-3">Admin Sign In</h4>
      <div id="login-error" class="alert alert-danger hidden"></div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input id="email" class="form-control" type="email" />
      </div>
      <div class="mb-3">
        <label class="form-label">Password</label>
        <input id="password" class="form-control" type="password" />
      </div>
      <button id="btn-login" class="btn btn-success w-100">Sign In</button>
      <p class="mt-3 text-muted small text-center">Use your registered admin credentials.</p>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="card p-4">
        <h4>Welcome, Admin!</h4>
        <p>Manage your Events and News below.</p>
        <button id="btn-logout2" class="btn btn-outline-danger mb-3">Logout</button>

        <!-- EVENTS -->
        <section class="mb-4">
          <h5>Upcoming Events</h5>
          <div id="events-list" class="mb-3"></div>

          <input id="ev-title" class="form-control mb-2" placeholder="Event Title" />
          <input id="ev-date" type="date" class="form-control mb-2" />
          <input id="ev-link" class="form-control mb-2" placeholder="Event Link (optional)" />
          <textarea id="ev-desc" class="form-control mb-2" rows="3" placeholder="Short Description"></textarea>
          <input id="ev-image" type="file" accept="image/*" class="form-control mb-2" />

          <div class="d-flex gap-2">
            <button id="btn-add-event" class="btn btn-primary">Add Event</button>
            <button id="btn-update-event" class="btn btn-warning hidden">Update Event</button>
            <button id="btn-cancel-edit" class="btn btn-secondary hidden">Cancel</button>
          </div>
        </section>

        <!-- NEWS -->
        <section>
          <h5>News & Press</h5>
          <div id="news-list" class="mb-3"></div>

          <input id="news-title" class="form-control mb-2" placeholder="News Title" />
          <input id="news-date" type="date" class="form-control mb-2" />
          <textarea id="news-body" class="form-control mb-2" rows="5" placeholder="News Content"></textarea>
          <input id="news-image" type="file" accept="image/*" class="form-control mb-2" />

          <div class="d-flex gap-2">
            <button id="btn-add-news" class="btn btn-primary">Add News</button>
            <button id="btn-update-news" class="btn btn-warning hidden">Update News</button>
            <button id="btn-cancel-news-edit" class="btn btn-secondary hidden">Cancel</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Firebase + Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="firebase-init.js"></script>

  <!-- ✅ Main Script -->
  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // DOM elements
    const loginArea = document.getElementById('login-area');
    const dashboard = document.getElementById('dashboard');
    const emailEl = document.getElementById('email');
    const pwdEl = document.getElementById('password');
    const loginError = document.getElementById('login-error');
    const userEmailSpan = document.getElementById('user-email');
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const btnLogout2 = document.getElementById('btn-logout2');

    // Login
    btnLogin.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = pwdEl.value;
      loginError.classList.add('hidden');
      if (!email || !password) {
        loginError.textContent = "Please enter both email and password.";
        loginError.classList.remove('hidden');
        return;
      }
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (err) {
        loginError.textContent = err.message;
        loginError.classList.remove('hidden');
      }
    });

    // Logout
    btnLogout.addEventListener('click', () => auth.signOut());
    btnLogout2.addEventListener('click', () => auth.signOut());

    // Auth state
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const adminDoc = await db.collection('meta').doc('adminsList').get();
        const admins = adminDoc.data() || {};
        if (admins[user.uid]) {
          userEmailSpan.textContent = user.email;
          loginArea.classList.add('hidden');
          dashboard.classList.remove('hidden');
          btnLogout.classList.remove('hidden');
          loadEvents();
          loadNews();
        } else {
          alert('You are not authorized as an admin.');
          await auth.signOut();
        }
      } else {
        userEmailSpan.textContent = '';
        loginArea.classList.remove('hidden');
        dashboard.classList.add('hidden');
        btnLogout.classList.add('hidden');
      }
    });

    // ==================== EVENTS ====================
    const eventsList = document.getElementById('events-list');
    const evTitle = document.getElementById('ev-title');
    const evDate = document.getElementById('ev-date');
    const evLink = document.getElementById('ev-link');
    const evDesc = document.getElementById('ev-desc');
    const evImage = document.getElementById('ev-image');
    const btnAddEvent = document.getElementById('btn-add-event');
    const btnUpdateEvent = document.getElementById('btn-update-event');
    const btnCancelEdit = document.getElementById('btn-cancel-edit');
    let currentEventId = null;

    async function loadEvents() {
      const snap = await db.collection('events').orderBy('date', 'asc').get();
      eventsList.innerHTML = '';
      if (snap.empty) return eventsList.innerHTML = '<p>No events found.</p>';
      snap.forEach(doc => {
        const e = doc.data();
        const div = document.createElement('div');
        div.className = 'border p-2 mb-2';
        div.innerHTML = `
          <strong>${e.title}</strong> — ${e.date}<br>
          ${e.desc}<br>
          <a href="${e.link}" target="_blank">${e.link || ''}</a><br>
          <button class="btn btn-sm btn-warning me-2" onclick="editEvent('${doc.id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteEvent('${doc.id}')">Delete</button>
        `;
        eventsList.appendChild(div);
      });
    }

    window.editEvent = async (id) => {
      const doc = await db.collection('events').doc(id).get();
      const e = doc.data();
      evTitle.value = e.title;
      evDate.value = e.date;
      evDesc.value = e.desc;
      evLink.value = e.link || '';
      currentEventId = id;
      btnAddEvent.classList.add('hidden');
      btnUpdateEvent.classList.remove('hidden');
      btnCancelEdit.classList.remove('hidden');
    };

    window.deleteEvent = async (id) => {
      if (confirm('Delete this event?')) {
        await db.collection('events').doc(id).delete();
        loadEvents();
      }
    };

    btnAddEvent.addEventListener('click', async () => {
      const newEvent = {
        title: evTitle.value,
        date: evDate.value,
        desc: evDesc.value,
        link: evLink.value
      };
      if (evImage.files[0]) {
        const ref = storage.ref('events/' + Date.now() + '-' + evImage.files[0].name);
        await ref.put(evImage.files[0]);
        newEvent.imageUrl = await ref.getDownloadURL();
      }
      await db.collection('events').add(newEvent);
      evTitle.value = evDate.value = evDesc.value = evLink.value = evImage.value = '';
      loadEvents();
    });

    btnUpdateEvent.addEventListener('click', async () => {
      const updated = {
        title: evTitle.value,
        date: evDate.value,
        desc: evDesc.value,
        link: evLink.value
      };
      if (evImage.files[0]) {
        const ref = storage.ref('events/' + Date.now() + '-' + evImage.files[0].name);
        await ref.put(evImage.files[0]);
        updated.imageUrl = await ref.getDownloadURL();
      }
      await db.collection('events').doc(currentEventId).update(updated);
      currentEventId = null;
      btnAddEvent.classList.remove('hidden');
      btnUpdateEvent.classList.add('hidden');
      btnCancelEdit.classList.add('hidden');
      evTitle.value = evDate.value = evDesc.value = evLink.value = evImage.value = '';
      loadEvents();
    });

    btnCancelEdit.addEventListener('click', () => {
      currentEventId = null;
      btnAddEvent.classList.remove('hidden');
      btnUpdateEvent.classList.add('hidden');
      btnCancelEdit.classList.add('hidden');
      evTitle.value = evDate.value = evDesc.value = evLink.value = evImage.value = '';
    });

    // ==================== NEWS ====================
    const newsList = document.getElementById('news-list');
    const newsTitle = document.getElementById('news-title');
    const newsDate = document.getElementById('news-date');
    const newsBody = document.getElementById('news-body');
    const newsImage = document.getElementById('news-image');
    const btnAddNews = document.getElementById('btn-add-news');
    const btnUpdateNews = document.getElementById('btn-update-news');
    const btnCancelNewsEdit = document.getElementById('btn-cancel-news-edit');
    let currentNewsId = null;

    async function loadNews() {
      const snap = await db.collection('news').orderBy('date', 'desc').get();
      newsList.innerHTML = '';
      if (snap.empty) return newsList.innerHTML = '<p>No news found.</p>';
      snap.forEach(doc => {
        const n = doc.data();
        const div = document.createElement('div');
        div.className = 'border p-2 mb-2';
        div.innerHTML = `
          <strong>${n.title}</strong> — ${n.date}<br>
          ${n.body.substring(0, 100)}...<br>
          <button class="btn btn-sm btn-warning me-2" onclick="editNews('${doc.id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteNews('${doc.id}')">Delete</button>
        `;
        newsList.appendChild(div);
      });
    }

    window.editNews = async (id) => {
      const doc = await db.collection('news').doc(id).get();
      const n = doc.data();
      newsTitle.value = n.title;
      newsDate.value = n.date;
      newsBody.value = n.body;
      currentNewsId = id;
      btnAddNews.classList.add('hidden');
      btnUpdateNews.classList.remove('hidden');
      btnCancelNewsEdit.classList.remove('hidden');
    };

    window.deleteNews = async (id) => {
      if (confirm('Delete this news article?')) {
        await db.collection('news').doc(id).delete();
        loadNews();
      }
    };

    btnAddNews.addEventListener('click', async () => {
      const newNews = {
        title: newsTitle.value,
        date: newsDate.value,
        body: newsBody.value
      };
      if (newsImage.files[0]) {
        const ref = storage.ref('news/' + Date.now() + '-' + newsImage.files[0].name);
        await ref.put(newsImage.files[0]);
        newNews.imageUrl = await ref.getDownloadURL();
      }
      await db.collection('news').add(newNews);
      newsTitle.value = newsDate.value = newsBody.value = newsImage.value = '';
      loadNews();
    });

    btnUpdateNews.addEventListener('click', async () => {
      const updated = {
        title: newsTitle.value,
        date: newsDate.value,
        body: newsBody.value
      };
      if (newsImage.files[0]) {
        const ref = storage.ref('news/' + Date.now() + '-' + newsImage.files[0].name);
        await ref.put(newsImage.files[0]);
        updated.imageUrl = await ref.getDownloadURL();
      }
      await db.collection('news').doc(currentNewsId).update(updated);
      currentNewsId = null;
      btnAddNews.classList.remove('hidden');
      btnUpdateNews.classList.add('hidden');
      btnCancelNewsEdit.classList.add('hidden');
      newsTitle.value = newsDate.value = newsBody.value = newsImage.value = '';
      loadNews();
    });

    btnCancelNewsEdit.addEventListener('click', () => {
      currentNewsId = null;
      btnAddNews.classList.remove('hidden');
      btnUpdateNews.classList.add('hidden');
      btnCancelNewsEdit.classList.add('hidden');
      newsTitle.value = newsDate.value = newsBody.value = newsImage.value = '';
    });
  </script>
</body>
</html>
